<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>扫描规则配置</title>
    <link rel="stylesheet" href="/static/component/pear/css/pear.css" />
    <link rel="stylesheet" href="/static/component/layui/css/font-awesome.min.css">
    <style>
        body {
            background-color: #f5f7fa;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        .layui-container {
            margin-top: 30px;
            padding-bottom: 30px;
        }

        .layui-card {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .layui-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .layui-card-header {
            background-color: #f8f9fa;
            color: #333;
            font-size: 16px;
            font-weight: 500;
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
        }

        .layui-card-header i {
            margin-right: 8px;
            color: #1E9FFF;
        }

        .layui-card-body {
            padding: 25px;
        }

        .rule-block {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: #fff;
            position: relative;
            transition: all 0.2s ease;
        }

        .rule-block:hover {
            border-color: #dcdfe6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .rule-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: #1E9FFF;
            border-radius: 4px 0 0 4px;
        }

        .rule-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding-left: 5px;
        }

        .rule-item .layui-form-select {
            width: 135px;
            margin-right: 10px;
        }

        .rule-value {
            flex: 1;
            margin-right: 10px;
        }

        .btn-add, .btn-remove {
            width: 26px;
            height: 26px;
            line-height: 26px;
            text-align: center;
            border-radius: 50%;
            display: inline-block;
            transition: all 0.2s ease;
            font-weight: bold;
        }

        .btn-add {
            margin-left: 10px;
            cursor: pointer;
            color: #1E9FFF;
            background-color: rgba(30, 159, 255, 0.1);
        }

        .btn-add:hover {
            background-color: rgba(30, 159, 255, 0.2);
        }

        .btn-remove {
            margin-left: 10px;
            cursor: pointer;
            color: #FF5722;
            background-color: rgba(255, 87, 34, 0.1);
        }

        .btn-remove:hover {
            background-color: rgba(255, 87, 34, 0.2);
        }

        .layui-form-label {
            width: 120px;
            color: #666;
            font-weight: 500;
            padding: 9px 15px;
        }

        .layui-input-block {
            margin-left: 150px;
        }

        .layui-input, .layui-select, .layui-textarea {
            border-radius: 4px;
            border-color: #dcdfe6;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .layui-input:focus, .layui-select:focus, .layui-textarea:focus {
            border-color: #1E9FFF;
            box-shadow: 0 0 0 2px rgba(30, 159, 255, 0.2);
        }

        .layui-form-item {
            margin-bottom: 20px;
        }

        .layui-form-item:last-child {
            margin-bottom: 0;
        }

        .layui-btn {
            border-radius: 4px;
            padding: 0 18px;
            height: 36px;
            line-height: 36px;
            transition: all 0.2s ease;
        }

        .layui-btn-normal {
            background-color: #1E9FFF;
        }

        .layui-btn-normal:hover {
            background-color: #0aa1ed;
        }

        .layui-btn-primary:hover {
            background-color: #f2f3f5;
            color: #1E9FFF;
        }

        .layui-btn-danger {
            background-color: #FF5722;
        }

        .layui-btn-danger:hover {
            background-color: #f5471a;
        }

        .form-actions {
            margin-top: 30px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .form-actions .layui-btn {
            margin: 0 8px;
        }

        .rule-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 15px;
            padding-left: 5px;
            font-size: 14px;
        }

        .required-mark {
            color: #FF5722;
            margin-right: 4px;
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .rule-block {
            animation: fadeIn 0.3s ease forwards;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .layui-form-label {
                width: 100px;
            }

            .layui-input-block {
                margin-left: 130px;
            }

            .rule-item .layui-form-select {
                width: 110px;
            }

            .layui-card-body {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .layui-form-label {
                width: 100%;
                display: block;
            }

            .layui-input-block {
                margin-left: 0;
                margin-top: 10px;
            }

            .rule-item {
                flex-wrap: wrap;
            }

            .rule-item .layui-form-select {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }

            .rule-value {
                width: calc(100% - 80px);
            }
        }
    </style>
</head>
<body>
    <div class="layui-container">
        <div class="layui-card">
            <div class="layui-card-header">
                <i class="fa fa-cogs"></i>扫描规则配置
            </div>
            <div class="layui-card-body">
                <form class="layui-form" id="ruleForm">
                    <div id="rules-container">
                        <div class="layui-form-item layui-form-text">
                            <label class="layui-form-label"><b class="required-mark">*</b>Host</label>
                            <div class="layui-input-block">
                                <input type="text" name="host" class="layui-input host" placeholder="www.xxx.xxx:8080" required>
                            </div>
                        </div>
                        <div class="layui-form-item layui-form-text">
                            <label class="layui-form-label"><b class="required-mark">*</b>部门</label>
                            <div class="layui-input-block">
                                <input type="text" name="department" class="layui-input department" required>
                            </div>
                        </div>

                        <div class="layui-form-item layui-form-text">
                            <label class="layui-form-label"><b class="required-mark">*</b>业务线</label>
                            <div class="layui-input-block">
                                <input type="text" name="businessline" class="layui-input businessline" required>
                            </div>
                        </div>

                        <div class="layui-form-item layui-form-text">
                            <label class="layui-form-label"><b class="required-mark">*</b>创建人</label>
                            <div class="layui-input-block">
                                <input type="text" name="createOwner" class="layui-input createOwner" value="admin" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="btn-add-rule" class="layui-btn layui-btn-normal">
                            <i class="fa fa-plus"></i> 新增规则
                        </button>
                        <button type="button" id="btn-submit" class="layui-btn">
                            <i class="fa fa-check"></i> 提交配置
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/static/component/layui/layui.js"></script>
    <script src="/static/component/pear/pear.js"></script>
    <script>
        layui.use(['form', 'layer', 'jquery'], function() {
            var form = layui.form;
            var layer = layui.layer;
            var ruleCount = 0; // 记录规则块数量
            var $ = layui.$;

            // 从URL获取ID参数
            function getUrlParam(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) return unescape(r[2]);
                return null;
            }

            // 获取当前编辑的ID
            var id = getUrlParam('id');

            // 初始化表单验证
            form.verify({
                ruleName: function(value) {
                    if(value.length < 2) {
                        return '规则名称至少需要2个字符';
                    }
                },
                ruleValue: function(value, item) {
                    var $select = $(item).prev('.rule-type');
                    var ruleType = $select.val();

                    // 对于添加和修改，验证格式
                    if((ruleType === 'addHeader' || ruleType === 'changeHeader') && !value.includes(':')) {
                        return '格式应为"Header名称:值"';
                    }
                }
            });

            // 加载数据
            function loadData() {
                if (!id) {
                    // 添加一个空规则块
                    addRuleBlock({}, 0);
                    return
                }

                var loading = layer.load();
                $.ajax({
                    url: "/api/ruleConfig/get?id=" + id,
                    type: 'GET',
                    success: function(res) {
                        let result = res.data
                        layer.close(loading);
                        if (result.id) {
                            // 填充基础数据
                            $('.host').val(result.scanHost || '');
                            $('.department').val(result.department || '');
                            $('.businessline').val(result.businessline || '');
                            $('.createOwner').val(result.createOwner || '');

                            // 解析并加载规则数据
                            if (result.scanRule) {
                                try {
                                    var rules = JSON.parse(result.scanRule);
                                    if (Array.isArray(rules) && rules.length > 0) {
                                        // 加载每个规则
                                        rules.forEach(function(rule, index) {
                                            addRuleBlock(rule, index);
                                        });
                                    } else {
                                        // 添加一个空规则块
                                        addRuleBlock({}, 0);
                                    }
                                } catch (e) {
                                    layer.msg('解析规则失败', {icon: 2});
                                    // 添加一个空规则块
                                    addRuleBlock({}, 0);
                                }
                            } else {
                                // 添加一个空规则块
                                addRuleBlock({}, 0);
                            }
                        } else {
                            layer.msg('获取配置数据失败', {icon: 2});
                        }
                    },
                    error: function() {
                        layer.close(loading);
                        layer.msg('加载数据失败', {icon: 2});
                    }
                });
            }
            loadData();

            // 添加规则块并填充数据
            function addRuleBlock(ruleData, index) {
                ruleCount = index; // 同步索引
                var ruleBlock = `
                    <div class="rule-block">
                        <div class="rule-title"><i class="fa fa-list-alt" style="margin-right:5px;color:#1E9FFF;"></i>规则配置 #${index + 1}</div>

                        <div class="layui-form-item">
                            <label class="layui-form-label"><b class="required-mark">*</b>规则名称</label>
                            <div class="layui-input-block">
                                <input type="text" name="ruleName[]" placeholder="请输入规则名称"
                                       value="${ruleData.ruleName || ''}" class="layui-input" required>
                            </div>
                        </div>

                        <div class="layui-form-item">
                            <label class="layui-form-label"><b class="required-mark">*</b>请求方法</label>
                            <div class="layui-input-block">
                                <div class="rule-items">
                                    <div class="rule-item">
                                        <select name="ruleMethod[]" class="rule-method" required>
                                            <option value="*" ${ruleData.ruleMethod === '*' ? 'selected' : ''}>*</option>
                                            <option value="GET" ${ruleData.ruleMethod === 'GET' ? 'selected' : ''}>GET</option>
                                            <option value="POST" ${ruleData.ruleMethod === 'POST' ? 'selected' : ''}>POST</option>
                                            <option value="PUT" ${ruleData.ruleMethod === 'PUT' ? 'selected' : ''}>PUT</option>
                                            <option value="DELETE" ${ruleData.ruleMethod === 'DELETE' ? 'selected' : ''}>DELETE</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="layui-form-item">
                            <label class="layui-form-label"><b class="required-mark">*</b>规则配置</label>
                            <div class="layui-input-block">
                                <div class="rule-items" id="ruleItems-${index}"></div>
                            </div>
                        </div>

                        <div class="layui-form-item">
                            <label class="layui-form-label">规则描述</label>
                            <div class="layui-input-block">
                                <textarea name="describe[]" placeholder="请输入规则描述"
                                          class="layui-textarea">${ruleData.ruleDescribe || ''}</textarea>
                            </div>
                        </div>

                        <div class="layui-form-item" style="text-align: right;">
                            <button type="button" class="layui-btn layui-btn-danger layui-btn-sm btn-remove-rule">
                                <i class="fa fa-trash-o"></i> 删除规则
                            </button>
                        </div>
                    </div>
                `;

                $('#rules-container').append(ruleBlock);

                // 处理规则项数据
                var ruleItemsContainer = $(`#ruleItems-${index}`);
                var rules = ruleData.rules || {};
                var ruleEntries = [];

                // 收集所有规则项
                if (rules.addHeader && Array.isArray(rules.addHeader)) {
                    rules.addHeader.forEach(function(value) {
                        ruleEntries.push({type: 'addHeader', value: value});
                    });
                }
                if (rules.changeHeader && Array.isArray(rules.changeHeader)) {
                    rules.changeHeader.forEach(function(value) {
                        ruleEntries.push({type: 'changeHeader', value: value});
                    });
                }
                if (rules.removeHeader && Array.isArray(rules.removeHeader)) {
                    rules.removeHeader.forEach(function(value) {
                        ruleEntries.push({type: 'removeHeader', value: value});
                    });
                }

                // 如果没有规则项，添加一个默认的
                if (ruleEntries.length === 0) {
                    ruleEntries.push({type: 'addHeader', value: ''});
                }

                // 添加规则项
                ruleEntries.forEach(function(entry, itemIndex) {
                    var addButton = itemIndex === ruleEntries.length - 1 ? '<span class="btn-add">+</span>' : '';
                    var removeButton = itemIndex > 0 ? '<span class="btn-remove">-</span>' : '';

                    var ruleItem = `
                        <div class="rule-item">
                            <select name="ruleType[${index}][]" class="rule-type" required>
                                <option value="addHeader" ${entry.type === 'addHeader' ? 'selected' : ''}>addHeader</option>
                                <option value="changeHeader" ${entry.type === 'changeHeader' ? 'selected' : ''}>changeHeader</option>
                                <option value="removeHeader" ${entry.type === 'removeHeader' ? 'selected' : ''}>removeHeader</option>
                            </select>
                            <input type="text" name="ruleValue[${index}][]"
                                   placeholder="${entry.type === 'removeHeader' ? 'Header名称' : 'Header名称:值'}"
                                   value="${entry.value || ''}"
                                   class="layui-input rule-value" required>
                            ${addButton}
                            ${removeButton}
                        </div>
                    `;

                    ruleItemsContainer.append(ruleItem);
                });

                form.render(); // 重新渲染表单元素
                bindEvents(); // 绑定新增元素的事件
            }

            // 新增规则块
            $('#btn-add-rule').on('click', function() {
                ruleCount++;
                addRuleBlock({}, ruleCount);
                // 平滑滚动到新增的规则块
                $('html, body').animate({
                    scrollTop: $('.rule-block:last').offset().top - 100
                }, 300);
            });

            // 绑定事件处理函数
            function bindEvents() {
                // 添加规则项
                $('.btn-add').off('click').on('click', function() {
                    var $this = $(this);
                    var $ruleItems = $this.closest('.rule-items');
                    var $lastItem = $ruleItems.find('.rule-item:last');
                    var ruleIndex = $lastItem.find('select').attr('name').match(/\[(\d+)\]/)[1];

                    var newItem = `
                        <div class="rule-item">
                            <select name="ruleType[${ruleIndex}][]" class="rule-type" required>
                                <option value="addHeader">addHeader</option>
                                <option value="changeHeader">changeHeader</option>
                                <option value="removeHeader">removeHeader</option>
                            </select>
                            <input type="text" name="ruleValue[${ruleIndex}][]" placeholder="Header名称:值"
                                   class="layui-input rule-value" required>
                            <span class="btn-add">+</span>
                            <span class="btn-remove">-</span>
                        </div>
                    `;

                    $lastItem.after(newItem);
                    form.render('select'); // 重新渲染下拉框
                    bindEvents(); // 重新绑定事件
                });

                // 删除规则项
                $('.btn-remove').off('click').on('click', function() {
                    var $ruleItems = $(this).closest('.rule-items');
                    if($ruleItems.find('.rule-item').length > 1) {
                        $(this).closest('.rule-item').remove();
                    } else {
                        layer.msg('至少保留一个项目', {icon: 2});
                    }
                });

                // 删除规则块
                $('.btn-remove-rule').off('click').on('click', function() {
                    var $ruleBlock = $(this).closest('.rule-block');
                    if($('#rules-container .rule-block').length > 1) {
                        // 添加删除动画
                        $ruleBlock.css({
                            'opacity': '0',
                            'transform': 'translateX(20px)',
                            'transition': 'all 0.3s ease'
                        });
                        setTimeout(function() {
                            $ruleBlock.remove();
                            // 更新规则编号
                            $('.rule-block').each(function(index) {
                                $(this).find('.rule-title').text(`规则配置 #${index + 1}`);
                            });
                        }, 300);
                    } else {
                        layer.msg('至少保留一个规则', {icon: 2});
                    }
                });

                // 根据选择类型动态更新占位符
                $('.rule-type').off('change').on('change', function() {
                    var $this = $(this);
                    var $input = $this.next('.rule-value');
                    var ruleType = $this.val();

                    if(ruleType === 'removeHeader') {
                        $input.attr('placeholder', 'Header名称');
                    } else {
                        $input.attr('placeholder', 'Header名称:值');
                    }
                });
            }

            // 提交表单
            $('#btn-submit').on('click', function() {
                // 表单验证
                var isValid = true;

                // 检查必填字段
                $('.layui-input[required], .layui-select[required]').each(function() {
                    if(!$(this).val()) {
                        isValid = false;
                        // 高亮显示未填写的字段
                        $(this).css('border-color', '#FF5722');
                        setTimeout(() => {
                            $(this).css('border-color', '');
                        }, 2000);
                    }
                });

                if(!isValid) {
                    layer.msg('请填写所有必填字段', {icon: 2});
                    return;
                }

                var requestData = serializeForm();
                if($('#btn-submit').hasClass('layui-btn-disabled')){
                    return false;
                }
                $('#btn-submit').addClass('layui-btn-disabled').html('<i class="fa fa-spinner fa-spin"></i> 提交中...');

                $.ajax({
                  url: "/api/ruleConfig/add",
                  data: JSON.stringify(requestData),
                  contentType: 'application/json',
                  type: 'POST',
                  success: function(result) {
                    if (result.code === 200) {
                      var index = layer.msg(result.message, {title: '提示',icon: 1, time: 500
                      }, function() {
                        window.parent.parent.postMessage('refreshCorpList', '*');
                        parent.layui.table.reload("corpTableId");
                        layer.close(index);
                        var iframeIndex = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(iframeIndex);
                      })
                    } else {
                      layer.alert(result.message, {title: '失败',icon: 2});
                      $('#btn-submit').removeClass('layui-btn-disabled').html('<i class="fa fa-check"></i> 提交配置');
                    }
                  },
                  error: function (e) {
                    layer.alert('未知错误！！', {title: '错误', icon: 2});
                    $('#btn-submit').removeClass('layui-btn-disabled').html('<i class="fa fa-check"></i> 提交配置');
                  }
                });
            });

            // 序列化表单数据为指定格式
            function serializeForm() {
                var subData = {}
                if (id) {
                    subData = {
                        id: id,
                        host: $('.host').val(),
                        department: $('.department').val(),
                        businessline: $('.businessline').val(),
                        createOwner: $('.createOwner').val()
                    }
                }else{
                    subData = {
                        host: $('.host').val(),
                        department: $('.department').val(),
                        businessline: $('.businessline').val(),
                        createOwner: $('.createOwner').val()
                    }
                }

                var rules = [];
                $('.rule-block').each(function(blockIndex) {
                    var rule = {
                        ruleName: $(this).find('input[name="ruleName[]"]').val(),
                        ruleDescribe: $(this).find('textarea[name="describe[]"]').val(),
                        ruleMethod: $(this).find('select[name="ruleMethod[]"]').val(),
                        rules: {}
                    };

                    // 收集规则配置
                    $(this).find('.rule-item').each(function() {
                        var ruleType = $(this).find('.rule-type').val();
                        var ruleValue = $(this).find('.rule-value').val();

                        if(ruleType === 'addHeader') {
                            if(!Object.hasOwn(rule.rules, 'addHeader')){
                                if(ruleValue !== '') {
                                    rule.rules.addHeader = []
                                    rule.rules.addHeader.push(ruleValue)
                                }
                            }else {
                                if(ruleValue !== '') {
                                    rule.rules.addHeader.push(ruleValue)
                                }
                            }
                        } else if(ruleType === 'changeHeader') {
                            if(!Object.hasOwn(rule.rules, 'changeHeader')){
                                if(ruleValue !== '') {
                                    rule.rules.changeHeader = []
                                    rule.rules.changeHeader.push(ruleValue)
                                }
                            }else {
                                if(ruleValue !== '') {
                                    rule.rules.changeHeader.push(ruleValue)
                                }
                            }
                        } else if(ruleType === 'removeHeader') {
                            if(!Object.hasOwn(rule.rules, 'removeHeader')){
                                if(ruleValue !== '') {
                                    rule.rules.removeHeader = []
                                    rule.rules.removeHeader.push(ruleValue)
                                }
                            }else {
                                if(ruleValue !== '') {
                                    rule.rules.removeHeader.push(ruleValue)
                                }
                            }
                        }
                    });

                    rules.push(rule);
                });
                subData.rules = rules
                return subData;
            }

            // 初始化绑定事件
            bindEvents();
        });
    </script>
</body>
</html>
